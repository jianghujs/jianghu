{% extends 'template/jhTemplateV4.html'%}

{% block vueTemplate %}

<script type="text/html" id="app-template">
  <div>
    <v-app>
      <v-main>
        <v-row class="align-center" style="height: 100vh">
          <v-col cols="12" align="center">
            <div class="mb-10 text-h7 font-weight-bold success--text"><$ ctx.app.config.appTitle $>11</div>
            <v-card class="login-form-card pa-8">
              <v-card-text class="pa-0">
                
                <!-- ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·åå¯†ç ç™»å½• -->
                <div v-if="loginStep === 1">
                  <div class="title">ç™»å½•æ‚¨çš„è´¦æˆ·</div>
                  <v-form ref="loginForm" lazy-validation>
                    <!--è¡¨å• [æ³¨ï¼šç™»å½•è¡¨å•åŒ…å«å¯†ç è¾“å…¥æ¡†ï¼Œchromeå¯†ç è‡ªåŠ¨å¡«å……çš„æ—¶å€™ä¼šä¸vuetifyçš„v-inputç»„ä»¶æ ·å¼å†²çªï¼Œä½¿ç”¨åŸç”Ÿinputé¿å…å†²çª]-->
                    <v-row class="my-0">
                      <v-col cols="12">
                        <input class="jh-cus-input" v-model="userId" placeholder="ç”¨æˆ·å"/>
                      </v-col>
                      <v-col cols="12">
                        <div class="password-wrapper">
                          <input
                            class="jh-cus-input"
                            v-model="password"
                            :type="isPasswordShown ? 'text' : 'password'"
                            data-type="password"
                            @keyup.enter.exact="doUiAction('login')"
                            placeholder="å¯†ç "
                          />
                          <v-icon @click="isPasswordShown = !isPasswordShown" small class="mdi-eye">{{isPasswordShown ? 'mdi-eye-off-outline' : 'mdi-eye-outline'}}</v-icon>
                        </div>
                      </v-col>
                      <v-col cols="12" v-if="captchaSvg">
                        <div class="captcha-wrapper">
                          <div 
                            class="captcha-image" 
                            @click="getCaptcha" 
                            title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç "
                          >
                            <img :src="captchaSvg" class="captcha-img" alt="éªŒè¯ç " />
                          </div>
                          <div>=</div>
                          <input
                            class="jh-cus-input captcha-input"
                            v-model="captchaCode"
                            type="text"
                            placeholder="éªŒè¯ç "
                          />
                        </div>
                      </v-col>
                      <v-col cols="12">
                        <v-checkbox class="jh-v-input" dense single-line filled v-model="isRememberPassword" color="success" label="è®°ä½å¯†ç "/>
                      </v-col>
                    </v-row>
                    <!--æ“ä½œæŒ‰é’®-->
                    <v-row class="my-0 px-3">
                      <v-btn block color="success" @click="doUiAction('login')" small :loading="isLoggingIn">ç™»å½•</v-btn>
                    </v-row>
                  </v-form>
                </div>

                <!-- ç¬¬äºŒæ­¥ï¼šMFAéªŒè¯ -->
                <div v-if="loginStep === 2">
                  <div class="title mb-4">äºŒæ¬¡éªŒè¯</div>
                  <div class="text-center mb-4">
                    <v-icon large color="primary">mdi-shield-key-outline</v-icon>
                    <div class="mt-2 text-body-2">è¯·è¾“å…¥Microsoft Authenticatorä¸­çš„éªŒè¯ç </div>
                    <div class="mt-1 text-caption text--secondary">éªŒè¯ç æ¯30ç§’æ›´æ–°ä¸€æ¬¡</div>
                  </div>
                  
                  <!-- MFAéªŒè¯ç»„ä»¶ -->
                  <mfa-verification-component
                    :challenge-id="mfaChallengeId"
                    page-id="login"
                    action-id="verifyMfaLogin"
                    submit-button-text="ç™»å½•"
                    :show-timer="false"
                    @verification-success="onMfaLoginSuccess"
                    @verification-failed="onMfaLoginFailed"
                    @challenge-expired="onMfaLoginExpired"
                    @max-retry-exceeded="onMfaLoginExpired"
                    @system-error="onMfaLoginFailed"
                  ></mfa-verification-component>
                  
                  <v-row class="my-2 px-3">
                    <v-btn block text small @click="doUiAction('backToStep1')">
                      <v-icon left small>mdi-arrow-left</v-icon>
                      è¿”å›é‡æ–°è¾“å…¥å¯†ç 
                    </v-btn>
                  </v-row>
                </div>

                <!-- éœ€è¦ç»‘å®šMFAæç¤º -->
                <div v-if="loginStep === 3">
                  <div class="title mb-4">éœ€è¦ç»‘å®šMFA</div>
                  <v-alert type="info" class="mb-4">
                    <div class="text-h6">ğŸ›¡ï¸ å®‰å…¨æé†’</div>
                    <div class="mt-2">ç³»ç»Ÿå·²å¯ç”¨å¤šå› å­è®¤è¯(MFA)ï¼Œè¯·å…ˆç»‘å®šMicrosoft Authenticatoråº”ç”¨ã€‚</div>
                  </v-alert>
                  
                  <v-row class="my-0 px-3">
                    <v-btn block color="primary" @click="redirectToPreMfaLoginURL" small>
                      å‰å¾€ç»‘å®šMFA
                    </v-btn>
                  </v-row>
                  <v-row class="my-2 px-3">
                    <v-btn block text small @click="doUiAction('backToStep1')">
                      <v-icon left small>mdi-arrow-left</v-icon>
                      è¿”å›ç™»å½•
                    </v-btn>
                  </v-row>
                </div>

              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </v-main>
    </v-app>

    <jh-toast/>
    <jh-mask/>
    <jh-confirm-dialog/>
  </div>
</script>

<div id="app">
</div>

{% endblock %}

{% block vueScript %}

<!-- åŠ è½½é¡µé¢ç»„ä»¶ -->
{% include 'utility/jianghuJs/prepareDeviceIdV4.html' %}

<!-- å¼•å…¥MFAéªŒè¯ç»„ä»¶ -->
{% include 'component/mfaVerification.html' %}

<script type="module">
  new Vue({
    el: '#app',
    template: '#app-template',
    vueComponent: 'page',
    vuetify: new Vuetify(),
    components: {},
    data() {
      return {
        // ç™»å½•æ­¥éª¤: 1-ç”¨æˆ·åå¯†ç , 2-MFAéªŒè¯, 3-éœ€è¦ç»‘å®šMFA
        loginStep: 1,
        userId: '',
        password: '',
        isPasswordShown: false,
        isRememberPassword: true,
        isLoggingIn: false,
        
        // MFAç›¸å…³æ•°æ®
        mfaChallengeId: null,
        loginResult: null,
        redirectUrl: null,
        
        // éªŒè¯ç ç›¸å…³æ•°æ®
        // éªŒè¯ç 
        enableLoginCaptcha: '<$ ctx.app.config.jianghuConfig.enableLoginCaptcha $>' === 'true',

        captchaSvg: '',
        captchaCode: ''
      };
    },
    async mounted() {
      await this.doUiAction('getUrlObj');
      await this.doUiAction('getCaptcha');
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'getUrlObj':
            await this.getUrlObj();
            break;
          case 'getCaptcha':
            await this.getCaptcha();
            break;
          case 'login':
            await this.prepareLoginData();
            await this.doMfaPasswordLogin();
            break;
          case 'backToStep1':
            await this.backToStep1();
            break;
          default:
            console.error("[doUiAction] uiActionId not found", { uiActionId });
            break;
        }
      },

      /**
       * è·å–URLå‚æ•°
       */
      async getUrlObj() {
        const urlObj = new URLSearchParams(location.search);

        if (urlObj.get('errorReason')) {
          window.vtoast.fail(urlObj.get('errorReason'));
        }

        this.redirectUrl = urlObj.get('redirectUrl');
      },

      /**
       * å‡†å¤‡ç™»å½•æ•°æ®
       */
      async prepareLoginData() {
        this.deviceId = window.deviceId;
        this.userId = _.replace(this.userId, /\s+/g, '');
        this.password = _.toString(this.password);
      },

      /**
       * æ‰§è¡ŒMFAå¯†ç ç™»å½•
       */
      async doMfaPasswordLogin() {
        this.isLoggingIn = true;
        
        try {
          const result = (await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'login',
                actionId: 'passwordLogin',
                actionData: {
                  userId: this.userId,
                  password: this.password,
                  deviceId: this.deviceId,
                  captchaCode: this.captchaCode
                },
              }
            }
          })).data.appData.resultData;

          if (result.success && !result.needBind) {
            // æƒ…å†µA: ç›´æ¥ç™»å½•æˆåŠŸï¼ˆæ— éœ€MFAï¼‰
            this.loginResult = result;
            await this.setLocalStorage();
            await this.redirectToPreLoginURL();
            window.vtoast.success('ç™»å½•æˆåŠŸ');
          } else if (result.success && result.needBind) {
            // æƒ…å†µB: ç™»å½•æˆåŠŸä½†éœ€è¦ç»‘å®šMFA - å…ˆä¿å­˜ç™»å½•ä¿¡æ¯ï¼Œç„¶åè·³è½¬åˆ°ç»‘å®šé¡µé¢
            this.loginResult = result;
            await this.setLocalStorage();
            await this.redirectToPreMfaLoginURL();
            window.vtoast.success('ç™»å½•æˆåŠŸï¼Œè¯·ç»‘å®šMFA');
          } else if (result.needMfa) {
            // æƒ…å†µC: éœ€è¦MFAéªŒè¯
            this.mfaChallengeId = result.challengeId;
            this.loginStep = 2;
            window.vtoast.success('å¯†ç éªŒè¯æˆåŠŸï¼Œè¯·è¾“å…¥MFAéªŒè¯ç ');
          } else {
            // å…¶ä»–é”™è¯¯æƒ…å†µ
            window.vtoast.fail(result.message || 'ç™»å½•å¤±è´¥');
          }
        } catch (error) {
          console.error('ç™»å½•å¤±è´¥:', error);
          this.getCaptcha();
          const { errorCode, errorReason } = error || {};
          if (errorCode) {
            window.vtoast.fail(errorReason);
          } else {
            window.vtoast.fail('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
          }
        } finally {
          this.isLoggingIn = false;
        }
      },
      
      /**
       * è·å–éªŒè¯ç 
       */
      async getCaptcha() {
        if (!this.enableLoginCaptcha) {
          return;
        }
        try {
          const result = await window.jianghuAxios({
            data: {
              appData: {
                pageId: 'login',
                actionId: 'getLoginCaptcha',
                actionData: {
                  deviceId: window.deviceId
                }
              }
            }
          });
          let captchaSvg = result.data.appData.resultData;
          if (captchaSvg) {
            this.captchaSvg = captchaSvg;
            this.captchaCode = '';
          }
        } catch (error) {
          console.error('è·å–éªŒè¯ç å¤±è´¥:', error);
        }
      },

      /**
       * è¿”å›ç¬¬ä¸€æ­¥
       */
      async backToStep1() {
        this.loginStep = 1;
        this.mfaChallengeId = null;
        this.password = ''; // æ¸…ç©ºå¯†ç ï¼Œå¢åŠ å®‰å…¨æ€§
      },

      /**
       * è®¾ç½®æœ¬åœ°å­˜å‚¨
       */
      async setLocalStorage() {
        if (this.loginResult) {
          localStorage.setItem(`${window.appInfo.appId}_authToken`, this.loginResult.authToken);
          localStorage.setItem(`${window.appInfo.appId}_userId`, this.loginResult.userId);
          localStorage.setItem(`${window.appInfo.appId}_deviceId`, this.deviceId);
        }
      },

      /**
       * é‡å®šå‘åˆ°ç™»å½•å‰é¡µé¢
       */
      async redirectToPreLoginURL() {
        let redirectTo = `/${window.appInfo.appId}`;
        if (this.redirectUrl) {
          redirectTo = decodeURIComponent(this.redirectUrl);
        }
        window.location.href = redirectTo;
      },

      async redirectToPreMfaLoginURL() {
        let redirectTo = `/${window.appInfo.appId}`;
        if (this.redirectUrl) {
          redirectTo = decodeURIComponent(this.redirectUrl);
          // æ·»åŠ MFAå‚æ•°åˆ°é‡å®šå‘URL
          if (redirectTo.indexOf('?') > -1) {
            redirectTo += '&mfa=true';
          } else {
            redirectTo += '?mfa=true';
          }
        }
        window.location.href = redirectTo;
      },

      // ========== MFAç»„ä»¶äº‹ä»¶å¤„ç†å™¨ ==========
      onMfaLoginSuccess(result) {
        this.loginResult = result;
        this.setLocalStorage();
        this.redirectToPreLoginURL();
        window.vtoast.success('ç™»å½•æˆåŠŸ');
      },

      onMfaLoginFailed(error) {
        console.error('MFAéªŒè¯å¤±è´¥:', error);
        // MFAéªŒè¯å¤±è´¥ï¼Œç”¨æˆ·å¯ä»¥é‡è¯•ï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†
      },

      onMfaLoginExpired() {
        window.vtoast.fail('éªŒè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
        this.doUiAction('backToStep1');
      },

    }
  });
</script>

<style scoped>
  .login-form-card {
    width: 400px;
  }

  /* ---------- è¾“å…¥æ¡† >>>>>>>>>> -------- */
  .jh-cus-input {
    border: 1px solid rgba(0, 0, 0, .06);
    width: 100%;
    height: 32px;
    border-radius: 6px;
    padding: 0 12px;
    color: #5E6278 !important;
    outline: none;
    font-size: 13px !important;
  }

  .jh-cus-input:focus,
  .jh-cus-input:focus-visible,
  input:focus-visible {
    border: thin solid #4caf50 !important;
  }

  /* ---------- <<<<<<<<<<< è¾“å…¥æ¡† -------- */

  /* ---------- å¯†ç æ¡† >>>>>>>>>> -------- */
  .password-wrapper {
    position: relative;
  }

  .password-wrapper .mdi-eye {
    position: absolute;
    right: 8px;
    top: 8px;
  }

  /* ---------- <<<<<<<<<<< å¯†ç æ¡† -------- */

  /* ---------- éªŒè¯ç æ¡† >>>>>>>>>> -------- */
  .captcha-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .captcha-image {
    cursor: pointer;
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 4px;
    overflow: hidden;
    min-width: 80px;
    height: 32px;
  }

  .captcha-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .captcha-input {
    flex: 1;
    min-width: 100px;
  }

  /* ---------- <<<<<<<<<<< éªŒè¯ç æ¡† -------- */
</style>
{% endblock %}